name: Missionary-Zeta GKI

on:
  workflow_dispatch:

jobs:
  Build-Kernel:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git make bc bison flex libssl-dev libelf-dev \
            python3 curl zip ccache \
            llvm lld

      # ===== FIXED CLANG SETUP (NO 404) =====
      - name: Setup AOSP Clang r450784
        run: |
          set -e
          mkdir -p /opt/clang
          git clone --depth=1 \
            https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 \
            /tmp/aosp-clang

          cp -r /tmp/aosp-clang/clang-r450784d/* /opt/clang/
          chmod -R a+rX /opt/clang
          echo "/opt/clang/bin" >> $GITHUB_PATH

      - name: Set Clang Environment
        run: |
          echo "CC=/opt/clang/bin/clang" >> $GITHUB_ENV
          echo "CXX=/opt/clang/bin/clang++" >> $GITHUB_ENV
          echo "LD=/opt/clang/bin/ld.lld" >> $GITHUB_ENV
          echo "LLVM=1" >> $GITHUB_ENV
          echo "LLVM_IAS=1" >> $GITHUB_ENV

      - name: Clone Kernel
        run: |
          git clone --depth=1 https://github.com/fjrXTR/gki-5.10.git kernel

      - name: Add KernelSU
        run: |
          rm -rf kernel/drivers/kernelsu
          git clone --depth=1 \
            https://github.com/RapliVx/KernelSU.git \
            kernel/drivers/kernelsu

      - name: Build Missionary-Zeta Kernel (Full LTO + PREEMPT + Hemat)
        run: |
          set -e
          export ARCH=arm64
          export SUBARCH=arm64
          # Compiler flags: performance but conservative for kernel stability and power efficiency
          export KCFLAGS="-O3 -pipe"
          export KCPPFLAGS="-O3"
          export KBUILD_BUILD_USER=Zeta
          export KBUILD_BUILD_HOST=Missionary

          mkdir -p kernel/out

          # base config
          make -C kernel O=out gki_defconfig

          # === scripts/config: full LTO, PREEMPT, energy-saving options, disable tracing/debug ===
          scripts/config --file kernel/out/.config \
            \
            # === CLANG / LTO === \
            -e CONFIG_CC_IS_CLANG \
            -e CONFIG_LD_LLD \
            -e CONFIG_LTO_CLANG \
            -e CONFIG_LTO_CLANG_FULL \
            -d CONFIG_THINLTO \
            -d CONFIG_GCC_PLUGINS \
            \
            # === PREEMPT (RESPONSIVE) === \
            -e CONFIG_PREEMPT \
            -e CONFIG_PREEMPT_DYNAMIC \
            -e CONFIG_PREEMPT_COUNT \
            \
            # === TIMER / TICK (HEMAT DAYA) === \
            -e CONFIG_HIGH_RES_TIMERS \
            -e CONFIG_TICK_ONESHOT \
            -e CONFIG_NO_HZ_COMMON \
            -e CONFIG_NO_HZ_IDLE \
            -e CONFIG_HZ_300 \
            \
            # === SCHEDULER (BALANCE, BUKAN BOROS) === \
            -e CONFIG_SCHED_AUTOGROUP \
            -e CONFIG_SCHED_CORE \
            -e CONFIG_SCHED_HRTICK \
            -e CONFIG_UCLAMP_TASK \
            \
            # === CPUFREQ / IDLE === \
            -e CONFIG_CPU_FREQ \
            -e CONFIG_CPU_FREQ_GOV_SCHEDUTIL \
            -e CONFIG_CPU_IDLE \
            -e CONFIG_CPU_IDLE_GOV_MENU \
            -e CONFIG_CPU_IDLE_GOV_TEO \
            \
            # === RCU (HEMAT BACKGROUND) === \
            -e CONFIG_RCU_EXPERT \
            -e CONFIG_RCU_NOCB_CPU \
            -e CONFIG_RCU_BOOST \
            -e CONFIG_RCU_BOOST_DELAY \
            \
            # === MEMORY / ZRAM === \
            -e CONFIG_ZRAM \
            -e CONFIG_ZRAM_DEF_COMP_LZ4 \
            -e CONFIG_CRYPTO_LZ4 \
            \
            # === ARM64 EFFICIENCY & SECURITY === \
            -e CONFIG_ARM64_PAN \
            -e CONFIG_ARM64_UAO \
            -e CONFIG_ARM64_PTR_AUTH \
            -e CONFIG_ARM64_BTI \
            \
            # === SIZE + POWER SAVING (turn off heavy debug/tracing) === \
            -e CONFIG_OPTIMIZE_INLINING \
            -e CONFIG_DISABLE_UNUSED_SYMBOLS \
            -d CONFIG_DEBUG_KERNEL \
            -d CONFIG_KPROBES \
            -d CONFIG_FTRACE \
            -d CONFIG_FUNCTION_TRACER \
            \
            # === KERNELSU === \
            -e CONFIG_KSU \
            -e CONFIG_KSU_SUSFS \
            -e CONFIG_KSU_MANUAL_HOOK

          # finalize config and build
          make -C kernel O=out olddefconfig
          make -C kernel O=out -j$(nproc)

      - name: Package AnyKernel3
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git anykernel3
          cp kernel/out/arch/arm64/boot/Image anykernel3/
          cp kernel/out/arch/arm64/boot/dtbo.img anykernel3/ || true
          cd anykernel3
          zip -r ../Missionary-Zeta-Kernel.zip *

      - name: Upload Kernel
        uses: actions/upload-artifact@v4
        with:
          name: Missionary-Zeta Kernel
          path: Missionary-Zeta-Kernel.zip
