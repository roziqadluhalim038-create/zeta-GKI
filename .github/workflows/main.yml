name: zeta-missionary

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Free space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost
          sudo docker image prune -af
          sudo apt clean
          df -h

      - name: Install deps
        run: |
          sudo apt update
          sudo apt install -y git bc bison flex make curl zip python3 \
            libssl-dev libelf-dev llvm lld ccache xz-utils

      - name: Setup Clang 19
        run: |
          mkdir -p /opt/clang
          curl -L https://github.com/ClangBuiltLinux/llvm-project/releases/download/llvmorg-19.1.7/clang+llvm-19.1.7-x86_64-linux-gnu.tar.xz -o clang.tar.xz
          tar -xf clang.tar.xz -C /opt/clang --strip-components=1
          echo "/opt/clang/bin" >> $GITHUB_PATH
          clang --version

      - name: Clone kernel
        run: |
          git clone --depth=1 https://github.com/fjrXTR/gki-5.10 kernel

      - name: Add KernelSU-Next
        run: |
          rm -rf kernel/drivers/kernelsu
          git clone --depth=1 https://github.com/KernelSU-Next/KernelSU kernel/drivers/kernelsu

      - name: Build
        run: |
          export ARCH=arm64
          export SUBARCH=arm64
          export LLVM=1
          export LLVM_IAS=1
          export KBUILD_BUILD_USER=Zeta
          export KBUILD_BUILD_HOST=Missionary
          export KBUILD_BUILD_VERSION=-âœ¦zeta-missionary

          export CC="ccache clang"
          export CXX="ccache clang++"
          export LD=ld.lld
          export LDFLAGS="--threads=4"
          export KCFLAGS="-O3"

          export CCACHE_COMPRESS=1
          export CCACHE_COMPRESSLEVEL=5
          export CCACHE_MAXSIZE=8G

          ccache -M 8G
          ccache -z

          mkdir -p kernel/out
          make -C kernel O=out gki_defconfig

          ./kernel/scripts/config --file kernel/out/.config \
            -e CONFIG_CC_IS_CLANG \
            -e CONFIG_LD_LLD \
            -e CONFIG_LTO_CLANG \
            -e CONFIG_THINLTO \
            -d CONFIG_LTO_CLANG_FULL \
            -e CONFIG_UCLAMP_TASK \
            -e CONFIG_SCHED_CORE \
            -e CONFIG_SCHED_AUTOGROUP \
            -e CONFIG_SCHED_HRTICK \
            -e CONFIG_SCHED_MIGRATION_COST_NS \
            -e CONFIG_PREEMPT \
            -e CONFIG_PREEMPT_DYNAMIC \
            -e CONFIG_PREEMPT_COUNT \
            -e CONFIG_HZ_250 \
            -d CONFIG_HZ_300 \
            -e CONFIG_NO_HZ_COMMON \
            -e CONFIG_NO_HZ_IDLE \
            -e CONFIG_HIGH_RES_TIMERS \
            -e CONFIG_TICK_ONESHOT \
            -e CONFIG_CPU_FREQ_GOV_SCHEDUTIL \
            -e CONFIG_CPU_IDLE \
            -e CONFIG_CPU_IDLE_GOV_MENU \
            -e CONFIG_CPU_IDLE_GOV_TEO \
            -e CONFIG_CGROUPS \
            -e CONFIG_CGROUP_SCHED \
            -e CONFIG_CGROUP_CPUACCT \
            -e CONFIG_CGROUP_FREEZER \
            -e CONFIG_CGROUP_BPF \
            -e CONFIG_ZRAM \
            -e CONFIG_ZRAM_DEF_COMP_LZ4 \
            -e CONFIG_CRYPTO_LZ4 \
            -e CONFIG_ARM64_PAN \
            -e CONFIG_ARM64_UAO \
            -e CONFIG_ARM64_PTR_AUTH \
            -e CONFIG_ARM64_BTI \
            -e CONFIG_VDSO \
            -e CONFIG_OPTIMIZE_INLINING \
            -e CONFIG_DISABLE_UNUSED_SYMBOLS \
            -e CONFIG_KSU \
            -e CONFIG_KSU_SUSFS \
            -e CONFIG_KSU_MANUAL_HOOK

          make -C kernel O=out olddefconfig
          make -C kernel O=out -j$(nproc --ignore=2)
          ccache -s

      - name: Pack AnyKernel
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 anykernel
          cp kernel/out/arch/arm64/boot/Image anykernel/
          cd anykernel
          zip -r ../zeta-missionary.zip *

      - uses: actions/upload-artifact@v4
        with:
          name: zeta-missionary
          path: zeta-missionary.zip
