name: zeta-missionary

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git bc bison flex curl libssl-dev libelf-dev \
            clang lld llvm ccache python3 zip make build-essential xz-utils

      - name: Setup ccache
        run: |
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=8G" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          ccache -M 8G

      - name: Clone Valhaze kernel base
        run: |
          rm -rf kernel || true
          git clone --depth=1 https://github.com/fjrXTR/v1llx-gki-5.10 kernel

      - name: Install KernelSU (RapliVx repo)
        run: |
          set -e
          rm -rf kernel/drivers/kernelsu || true
          rm -rf kernel/KernelSU || true

          git clone --depth=1 https://github.com/RapliVx/KernelSU kernel/KernelSU

          # run KernelSU setup script from kernel root
          (cd kernel && bash KernelSU/kernel/setup.sh master)

      - name: Set kernel name & configure GKIDefconfig
        run: |
          export ARCH=arm64
          export LLVM=1
          export LLVM_IAS=1

          # generate GKIDefconfig
          make -C kernel O=out gkidefconfig

          # set local version
          kernel/scripts/config --file kernel/out/.config --set-str CONFIG_LOCALVERSION "-zeta-âœ¦missionary"

          # enable/disable extra options you wanted
          kernel/scripts/config --file kernel/out/.config \
            -e CONFIG_CC_IS_CLANG -e CONFIG_LD_LLD -e CONFIG_LTO_CLANG -e CONFIG_THINLTO \
            -d CONFIG_LTO_CLANG_FULL -e CONFIG_PREEMPT -e CONFIG_PREEMPT_DYNAMIC \
            -e CONFIG_PREEMPT_COUNT -e CONFIG_HZ_250 -e CONFIG_NO_HZ_COMMON \
            -e CONFIG_NO_HZ_IDLE -e CONFIG_HIGH_RES_TIMERS -e CONFIG_TICK_ONESHOT \
            -e CONFIG_SCHED_AUTOGROUP -e CONFIG_SCHED_CORE -e CONFIG_SCHED_HRTICK \
            -e CONFIG_UCLAMP_TASK -e CONFIG_CPU_FREQ_GOV_SCHEDUTIL -e CONFIG_CPU_IDLE \
            -e CONFIG_CPU_IDLE_GOV_MENU -e CONFIG_CPU_IDLE_GOV_TEO -e CONFIG_RCU_EXPERT \
            -e CONFIG_RCU_BOOST -e CONFIG_RCU_BOOST_DELAY -e CONFIG_RCU_NOCB_CPU \
            -e CONFIG_CGROUPS -e CONFIG_CGROUP_SCHED -e CONFIG_CGROUP_CPUACCT \
            -e CONFIG_CGROUP_FREEZER -e CONFIG_CGROUP_BPF -e CONFIG_NAMESPACES \
            -e CONFIG_USER_NS -e CONFIG_PID_NS -e CONFIG_NET_NS -e CONFIG_IPC_NS \
            -e CONFIG_ZRAM -e CONFIG_ZRAM_DEF_COMP_LZ4 -e CONFIG_CRYPTO_LZ4 \
            -e CONFIG_ARM64_PAN -e CONFIG_ARM64_UAO -e CONFIG_ARM64_PTR_AUTH \
            -e CONFIG_ARM64_BTI -e CONFIG_VDSO -e CONFIG_OPTIMIZE_INLINING \
            -e CONFIG_DISABLE_UNUSED_SYMBOLS -e CONFIG_KSU -e CONFIG_KSU_SUSFS \
            -e CONFIG_KSU_MANUAL_HOOK

          # resolve dependencies / fill defaults
          make -C kernel O=out olddefconfig

      - name: Build kernel
        run: |
          export ARCH=arm64
          export LLVM=1
          export LLVM_IAS=1
          export CC="ccache clang"
          export CXX="ccache clang++"
          export LD=ld.lld
          make -C kernel O=out -j$(nproc --ignore=2)

      - name: Pack AnyKernel3
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          cp kernel/out/arch/arm64/boot/Image ak3/
          cp kernel/out/arch/arm64/boot/dtbo.img ak3/ || true
          cd ak3
          zip -r ../zeta-missionary.zip *

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: zeta-missionary
          path: zeta-missionary.zip
