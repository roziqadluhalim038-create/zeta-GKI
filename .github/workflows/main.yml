name: Missionary-Zeta GKI

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Install required system packages
        run: |
          sudo apt update
          sudo apt install -y wget gnupg lsb-release \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu binutils-aarch64-linux-gnu \
            gcc-arm-linux-gnueabi g++-arm-linux-gnueabi binutils-arm-linux-gnueabi \
            binutils
          sudo apt install -y python3 jq

      - name: Install clang 21
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 21
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-21 100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-21 100
          sudo update-alternatives --install /usr/bin/ld.lld ld.lld /usr/bin/ld.lld-21 100
          clang --version

      - name: Create GCC64 tool wrappers and symlinks
        run: |
          sudo rm -rf /home/runner/gcc-64 || true
          mkdir -p /home/runner/gcc-64/bin
          cat > /home/runner/gcc-64/bin/aarch64-linux-android-gcc <<'EOF'
#!/bin/sh
exec clang --target=aarch64-linux-android --sysroot=/usr/aarch64-linux-gnu "$@"
EOF
          cat > /home/runner/gcc-64/bin/aarch64-linux-android-g++ <<'EOF'
#!/bin/sh
exec clang++ --target=aarch64-linux-android --sysroot=/usr/aarch64-linux-gnu "$@"
EOF
          chmod +x /home/runner/gcc-64/bin/aarch64-linux-android-gcc
          chmod +x /home/runner/gcc-64/bin/aarch64-linux-android-g++
          ln -sf /usr/bin/aarch64-linux-gnu-ar /home/runner/gcc-64/bin/aarch64-linux-android-ar
          ln -sf /usr/bin/aarch64-linux-gnu-ranlib /home/runner/gcc-64/bin/aarch64-linux-android-ranlib
          ln -sf /usr/bin/aarch64-linux-gnu-strip /home/runner/gcc-64/bin/aarch64-linux-android-strip
          ln -sf /usr/bin/aarch64-linux-gnu-objcopy /home/runner/gcc-64/bin/aarch64-linux-android-objcopy
          ln -sf /usr/bin/aarch64-linux-gnu-objdump /home/runner/gcc-64/bin/aarch64-linux-android-objdump
          ln -sf /usr/bin/aarch64-linux-gnu-nm /home/runner/gcc-64/bin/aarch64-linux-android-nm
          echo "/home/runner/gcc-64/bin" >> $GITHUB_PATH
          echo "GCC64=/home/runner/gcc-64/bin/aarch64-linux-android-gcc" >> $GITHUB_ENV
          ls -l /home/runner/gcc-64/bin

      - name: Create GCC32 tool wrappers and symlinks
        run: |
          sudo rm -rf /home/runner/gcc-32 || true
          mkdir -p /home/runner/gcc-32/bin
          cat > /home/runner/gcc-32/bin/arm-linux-androideabi-gcc <<'EOF'
#!/bin/sh
exec clang --target=armv7-none-linux-androideabi --sysroot=/usr/arm-linux-gnueabi "$@"
EOF
          cat > /home/runner/gcc-32/bin/arm-linux-androideabi-g++ <<'EOF'
#!/bin/sh
exec clang++ --target=armv7-none-linux-androideabi --sysroot=/usr/arm-linux-gnueabi "$@"
EOF
          chmod +x /home/runner/gcc-32/bin/arm-linux-androideabi-gcc
          chmod +x /home/runner/gcc-32/bin/arm-linux-androideabi-g++
          ln -sf /usr/bin/arm-linux-gnueabi-ar /home/runner/gcc-32/bin/arm-linux-androideabi-ar
          ln -sf /usr/bin/arm-linux-gnueabi-ranlib /home/runner/gcc-32/bin/arm-linux-androideabi-ranlib
          ln -sf /usr/bin/arm-linux-gnueabi-strip /home/runner/gcc-32/bin/arm-linux-androideabi-strip
          ln -sf /usr/bin/arm-linux-gnueabi-objcopy /home/runner/gcc-32/bin/arm-linux-androideabi-objcopy
          ln -sf /usr/bin/arm-linux-gnueabi-objdump /home/runner/gcc-32/bin/arm-linux-androideabi-objdump
          ln -sf /usr/bin/arm-linux-gnueabi-nm /home/runner/gcc-32/bin/arm-linux-androideabi-nm
          echo "/home/runner/gcc-32/bin" >> $GITHUB_PATH
          echo "GCC32=/home/runner/gcc-32/bin/arm-linux-androideabi-gcc" >> $GITHUB_ENV
          ls -l /home/runner/gcc-32/bin

      - name: Verify toolchain
        run: |
          which clang || true
          clang --version || true
          which aarch64-linux-android-gcc || true
          aarch64-linux-android-gcc --version || true
          which arm-linux-androideabi-gcc || true
          arm-linux-androideabi-gcc --version || true

      - uses: dabao1955/kernel_build_action@main
        with:
          kernel-url: https://github.com/fjrXTR/gki-5.10.git
          kernel-dir: kernel
          kernel-branch: villhaze-new
          config: gki_defconfig
          arch: arm64
          android-version: 12
          aosp-gcc: false
          aosp-clang: false
          disable-lto: false
          extra-make-args: >
            LLVM=1 LLVM_IAS=1 WERROR=0
            CONFIG_LOCALVERSION=âœ¦-Missionary-Zeta
            CONFIG_LTO_CLANG=y
            CONFIG_LTO_CLANG_FULL=y
            CONFIG_PREEMPT=y
            CONFIG_PREEMPT_DYNAMIC=n
            CONFIG_PREEMPT_VOLUNTARY=n
            CONFIG_PREEMPTION=y
            CONFIG_PREEMPT_COUNT=y
            CONFIG_KSU_SYSCALL_HOOK=y
            CONFIG_KPROBES=y
            CONFIG_KRETPROBES=y
            CONFIG_HAVE_SYSCALL_TRACEPOINTS=y
            CONFIG_HZ_250=y
            CONFIG_HZ=250
            CONFIG_TCP_CONG_BBRPLUS=y
            CONFIG_DEFAULT_TCP_CONG=bbrplus
            CONFIG_ZRAM_STREAMS=y
            CONFIG_ZRAM_DEF_COMP_THREADS=4
            CONFIG_WQ_POWER_EFFICIENT_DEFAULT=y
            CONFIG_SCHED_AUTOGROUP=y
            CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
            CONFIG_CPU_IDLE_GOV_TEO=y
            CONFIG_RCU_BOOST=y
            CONFIG_SLUB_DEBUG=n
            CONFIG_OPTIMIZE_INLINING=y
            CONFIG_VDSO=y
            CONFIG_DISABLE_UNUSED_SYMBOLS=y
            CONFIG_PANIC_TIMEOUT=0
            KCFLAGS=-Wno-error
            CONFIG_ENERGY_MODEL=y
            CONFIG_CPU_IDLE_GOV_MENU=n
            CONFIG_ARM_PSCI_CPUIDLE=y
            CONFIG_TICK_ONESHOT=y
            CONFIG_NO_HZ_FULL=y
            CONFIG_SCHED_MC=y
            CONFIG_PM_AUTOSLEEP=y
            CONFIG_PM_WAKELOCKS_LIMIT=0
            CONFIG_SCHED_HRTICK=y
            CONFIG_UCLAMP_TASK=y
            CONFIG_CRYPTO_LZ4=y
          anykernel3: true
