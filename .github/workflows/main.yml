name: zeta-missionary

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Free space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost || true
          sudo apt clean || true
          df -h

      - name: Install deps
        run: |
          sudo apt update
          sudo apt install -y git bc bison flex curl wget libssl-dev libelf-dev \
            clang lld llvm ccache python3 zip make build-essential xz-utils

      - name: Setup ccache
        run: |
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=10G" >> $GITHUB_ENV
          ccache -M 10G || true

      - name: Clone Valhaze base
        run: |
          rm -rf kernel || true
          git clone --depth=1 https://github.com/fjrXTR/v1llx-gki-5.10 kernel

      - name: Add KernelSU-Next (robust)
        run: |
          set -e
          rm -rf kernel/drivers/kernelsu || true
          mkdir -p kernel/drivers
          # try several repos
          if git clone --depth=1 https://github.com/KernelSU-Next/KernelSU.git kernel/drivers/kernelsu 2>/dev/null; then
            echo "Cloned KernelSU-Next"
          elif git clone --depth=1 https://github.com/tiann/KernelSU.git kernel/drivers/kernelsu 2>/dev/null; then
            echo "Cloned tiann/KernelSU"
          elif git clone --depth=1 https://github.com/RapliVx/KernelSU.git kernel/drivers/kernelsu 2>/dev/null; then
            echo "Cloned RapliVx/KernelSU"
          else
            echo "git clone failed for KernelSU repos — trying archive fallback"
            TMPDIR=$(mktemp -d)
            ARCHIVES="https://github.com/KernelSU-Next/KernelSU/archive/refs/heads/main.tar.gz https://github.com/tiann/KernelSU/archive/refs/heads/main.tar.gz https://github.com/RapliVx/KernelSU/archive/refs/heads/main.tar.gz"
            GOT=0
            for A in $ARCHIVES; do
              echo "Trying $A"
              if curl -fL --retry 3 "$A" -o "$TMPDIR/ksu.tar.gz"; then
                mkdir -p "$TMPDIR/ksu"
                tar -xzf "$TMPDIR/ksu.tar.gz" -C "$TMPDIR/ksu" || true
                SRCROOT=$(find "$TMPDIR/ksu" -maxdepth 2 -type d -name "KernelSU*" | head -n1 || true)
                if [ -z "$SRCROOT" ]; then
                  SRCROOT=$(find "$TMPDIR/ksu" -maxdepth 2 -type d | head -n1 || true)
                fi
                if [ -n "$SRCROOT" ]; then
                  mkdir -p kernel/drivers/kernelsu
                  if [ -d "$SRCROOT/kernel" ]; then
                    cp -a "$SRCROOT/kernel/"* kernel/drivers/kernelsu/ || true
                  elif [ -d "$SRCROOT/drivers/kernelsu" ]; then
                    cp -a "$SRCROOT/drivers/kernelsu/"* kernel/drivers/kernelsu/ || true
                  else
                    cp -a "$SRCROOT/"* kernel/drivers/kernelsu/ || true
                  fi
                  GOT=1
                  break
                fi
              else
                echo "Archive $A not available"
              fi
            done
            rm -rf "$TMPDIR" || true
            if [ "$GOT" -ne 1 ]; then
              echo "KernelSU not available remotely — creating minimal stub to avoid build failure"
              mkdir -p kernel/drivers/kernelsu/src || true
              echo 'config KSU' > kernel/drivers/kernelsu/Kconfig
              echo '    bool "KernelSU (stub)"' >> kernel/drivers/kernelsu/Kconfig
              echo '    default y' >> kernel/drivers/kernelsu/Kconfig
              echo 'obj-$(CONFIG_KSU) += kernelsu/' > kernel/drivers/kernelsu/Makefile
              echo 'kernelsu-y := src/ksu_stub.o' >> kernel/drivers/kernelsu/Makefile
              printf '%s\n' "#include <linux/module.h>" "static int __init ksu_stub_init(void) { return 0; }" "static void __exit ksu_stub_exit(void) {}" "module_init(ksu_stub_init);" "module_exit(ksu_stub_exit);" "MODULE_LICENSE(\"GPL\");" > kernel/drivers/kernelsu/src/ksu_stub.c
            fi
          fi
          # ensure drivers/Kconfig and drivers/Makefile reference kernelsu
          if ! grep -Fq 'drivers/kernelsu/Kconfig' kernel/drivers/Kconfig 2>/dev/null ; then
            echo 'source "drivers/kernelsu/Kconfig"' >> kernel/drivers/Kconfig
          fi
          if ! grep -Fq 'obj-$(CONFIG_KSU) += kernelsu/' kernel/drivers/Makefile 2>/dev/null ; then
            echo 'obj-$(CONFIG_KSU) += kernelsu/' >> kernel/drivers/Makefile
          fi
          ls -la kernel/drivers/kernelsu || true

      - name: Set kernel localversion
        run: |
          if grep -q '^CONFIG_LOCALVERSION' kernel/arch/arm64/configs/gki_defconfig 2>/dev/null; then
            sed -i 's/^CONFIG_LOCALVERSION.*/CONFIG_LOCALVERSION="-zeta-✦missionary"/' kernel/arch/arm64/configs/gki_defconfig || true
          else
            echo 'CONFIG_LOCALVERSION="-zeta-✦missionary"' >> kernel/arch/arm64/configs/gki_defconfig
          fi

      - name: Configure kernel (ThinLTO + tuning)
        run: |
          export ARCH=arm64
          export LLVM=1
          export LLVM_IAS=1
          export CC=clang
          export CXX=clang++
          export LD=ld.lld
          make -C kernel O=out gki_defconfig
          kernel/scripts/config --file kernel/out/.config -e CONFIG_CC_IS_CLANG -e CONFIG_LD_LLD -e CONFIG_LTO_CLANG -e CONFIG_THINLTO -d CONFIG_LTO_CLANG_FULL -e CONFIG_PREEMPT -e CONFIG_PREEMPT_DYNAMIC -e CONFIG_PREEMPT_COUNT -e CONFIG_HZ_250 -e CONFIG_NO_HZ_COMMON -e CONFIG_NO_HZ_IDLE -e CONFIG_HIGH_RES_TIMERS -e CONFIG_TICK_ONESHOT -e CONFIG_SCHED_AUTOGROUP -e CONFIG_SCHED_CORE -e CONFIG_SCHED_HRTICK -e CONFIG_UCLAMP_TASK -e CONFIG_CPU_FREQ_GOV_SCHEDUTIL -e CONFIG_CPU_IDLE -e CONFIG_CPU_IDLE_GOV_MENU -e CONFIG_CPU_IDLE_GOV_TEO -e CONFIG_RCU_EXPERT -e CONFIG_RCU_BOOST -e CONFIG_RCU_BOOST_DELAY -e CONFIG_RCU_NOCB_CPU -e CONFIG_CGROUPS -e CONFIG_CGROUP_SCHED -e CONFIG_CGROUP_CPUACCT -e CONFIG_CGROUP_FREEZER -e CONFIG_CGROUP_BPF -e CONFIG_NAMESPACES -e CONFIG_USER_NS -e CONFIG_PID_NS -e CONFIG_NET_NS -e CONFIG_IPC_NS -e CONFIG_ZRAM -e CONFIG_ZRAM_DEF_COMP_LZ4 -e CONFIG_CRYPTO_LZ4 -e CONFIG_ARM64_PAN -e CONFIG_ARM64_UAO -e CONFIG_ARM64_PTR_AUTH -e CONFIG_ARM64_BTI -e CONFIG_VDSO -e CONFIG_OPTIMIZE_INLINING -e CONFIG_DISABLE_UNUSED_SYMBOLS -e CONFIG_KSU -e CONFIG_KSU_SUSFS -e CONFIG_KSU_MANUAL_HOOK
          make -C kernel O=out olddefconfig

      - name: Build kernel (RAM-safe)
        run: |
          export ARCH=arm64
          export LLVM=1
          export LLVM_IAS=1
          export CC="ccache clang"
          export CXX="ccache clang++"
          export LD=ld.lld
          make -C kernel O=out -j$(nproc --ignore=2)

      - name: Pack AnyKernel3
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 anykernel
          cp kernel/out/arch/arm64/boot/Image anykernel/ || true
          cp kernel/out/arch/arm64/boot/dtbo.img anykernel/ || true
          cd anykernel
          zip -r ../zeta-missionary.zip *

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: zeta-missionary
          path: zeta-missionary.zip
