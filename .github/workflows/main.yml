name: Missionary-Zeta GKI

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Install system cross compiler into /opt/gcc-64
        run: |
          sudo apt update
          sudo apt install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu binutils-aarch64-linux-gnu
          sudo mkdir -p /opt/gcc-64/bin
          sudo ln -sf /usr/bin/aarch64-linux-gnu-gcc /opt/gcc-64/bin/aarch64-linux-android-gcc
          sudo ln -sf /usr/bin/aarch64-linux-gnu-g++ /opt/gcc-64/bin/aarch64-linux-android-g++
          sudo ln -sf /usr/bin/aarch64-linux-gnu-ar /opt/gcc-64/bin/aarch64-linux-android-ar
          sudo ln -sf /usr/bin/aarch64-linux-gnu-ranlib /opt/gcc-64/bin/aarch64-linux-android-ranlib
          sudo ln -sf /usr/bin/aarch64-linux-gnu-strip /opt/gcc-64/bin/aarch64-linux-android-strip
          echo "/opt/gcc-64/bin" >> $GITHUB_PATH
          ls -l /opt/gcc-64/bin

      - name: Clean possible existing /home/runner/gcc-64
        run: |
          if [ -d /home/runner/gcc-64 ]; then sudo rm -rf /home/runner/gcc-64; fi
          if [ -f /home/runner/gcc-64 ]; then sudo rm -f /home/runner/gcc-64; fi
          ls -la /home/runner | sed -n '1,200p'

      - name: Install clang 21
        run: |
          sudo apt update
          sudo apt install -y wget gnupg lsb-release
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 21
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-21 100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-21 100
          sudo update-alternatives --install /usr/bin/ld.lld ld.lld /usr/bin/ld.lld-21 100
          clang --version

      - uses: dabao1955/kernel_build_action@main
        with:
          kernel-url: https://github.com/fjrXTR/gki-5.10.git
          kernel-dir: gki-src
          kernel-branch: villhaze-new
          config: gki_defconfig
          arch: arm64
          android-version: 12
          aosp-gcc: true
          aosp-clang: false
          disable-lto: false
          extra-make-args: >
            LLVM=1 LLVM_IAS=1 WERROR=0
            CONFIG_LOCALVERSION=âœ¦-Missionary-Zeta
            CONFIG_LTO_CLANG=y
            CONFIG_LTO_CLANG_FULL=y
            CONFIG_PREEMPT=y
            CONFIG_PREEMPT_DYNAMIC=n
            CONFIG_PREEMPT_VOLUNTARY=n
            CONFIG_PREEMPTION=y
            CONFIG_PREEMPT_COUNT=y
            CONFIG_KSU_SYSCALL_HOOK=y
            CONFIG_KPROBES=y
            CONFIG_KRETPROBES=y
            CONFIG_HAVE_SYSCALL_TRACEPOINTS=y
            CONFIG_HZ_250=y
            CONFIG_HZ=250
            CONFIG_TCP_CONG_BBRPLUS=y
            CONFIG_DEFAULT_TCP_CONG=bbrplus
            CONFIG_ZRAM_STREAMS=y
            CONFIG_ZRAM_DEF_COMP_THREADS=4
            CONFIG_WQ_POWER_EFFICIENT_DEFAULT=y
            CONFIG_SCHED_AUTOGROUP=y
            CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
            CONFIG_CPU_IDLE_GOV_TEO=y
            CONFIG_RCU_BOOST=y
            CONFIG_SLUB_DEBUG=n
            CONFIG_OPTIMIZE_INLINING=y
            CONFIG_VDSO=y
            CONFIG_DISABLE_UNUSED_SYMBOLS=y
            CONFIG_PANIC_TIMEOUT=0
            KCFLAGS=-Wno-error
            CONFIG_ENERGY_MODEL=y
            CONFIG_CPU_IDLE_GOV_MENU=n
            CONFIG_ARM_PSCI_CPUIDLE=y
            CONFIG_TICK_ONESHOT=y
            CONFIG_NO_HZ_FULL=y
            CONFIG_SCHED_MC=y
            CONFIG_PM_AUTOSLEEP=y
            CONFIG_PM_WAKELOCKS_LIMIT=0
            CONFIG_SCHED_HRTICK=y
            CONFIG_UCLAMP_TASK=y
            CONFIG_CRYPTO_LZ4=y
          anykernel3: true
