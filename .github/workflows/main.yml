name: zeta-missionary

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Free space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost || true
          sudo apt clean || true
          df -h

      - name: Install deps
        run: |
          sudo apt update
          sudo apt install -y git bc bison flex curl libssl-dev libelf-dev \
            clang lld llvm ccache python3 zip make gcc wget xz-utils

      - name: Setup ccache
        run: |
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=10G" >> $GITHUB_ENV
          ccache -M 10G || true

      - name: Clone Valhaze GKI
        run: |
          git clone --depth=1 https://github.com/fjrXTR/v1llx-gki-5.10 kernel

      - name: Add KernelSU-Next (robust)
        run: |
          set -e
          rm -rf kernel/drivers/kernelsu || true

          if git clone --depth=1 https://github.com/KernelSU-Next/KernelSU.git kernel/drivers/kernelsu 2>/dev/null ; then
            echo "Cloned KernelSU via git"
          else
            echo "git clone failed — falling back to archive download"
            TMP=/tmp/ksu_$$
            mkdir -p $TMP
            ARCHIVE_URL="https://github.com/KernelSU-Next/KernelSU/archive/refs/heads/main.tar.gz"
            curl -fL --retry 3 "$ARCHIVE_URL" -o "$TMP/ksu.tar.gz"
            tar -xzf "$TMP/ksu.tar.gz" -C "$TMP"
            # copy sensible locations into drivers/kernelsu
            mkdir -p kernel/drivers/kernelsu
            if [ -d "$TMP/KernelSU-main/kernel" ]; then
              cp -a "$TMP/KernelSU-main/kernel/"* kernel/drivers/kernelsu/ || true
            elif [ -d "$TMP/KernelSU-main/drivers/kernelsu" ]; then
              cp -a "$TMP/KernelSU-main/drivers/kernelsu/"* kernel/drivers/kernelsu/ || true
            else
              cp -a "$TMP/KernelSU-main/"* kernel/drivers/kernelsu/ || true
            fi
            rm -rf "$TMP"
          fi

          # ensure Kconfig/Makefile reference kernelsu
          if ! grep -Fq 'drivers/kernelsu/Kconfig' kernel/drivers/Kconfig 2>/dev/null ; then
            echo 'source "drivers/kernelsu/Kconfig"' >> kernel/drivers/Kconfig
          fi
          if ! grep -Fq 'obj-$(CONFIG_KSU) += kernelsu/' kernel/drivers/Makefile 2>/dev/null ; then
            echo 'obj-$(CONFIG_KSU) += kernelsu/' >> kernel/drivers/Makefile
          fi
          ls -la kernel/drivers/kernelsu || true

      - name: Set kernel name
        run: |
          sed -i 's/CONFIG_LOCALVERSION=.*/CONFIG_LOCALVERSION="-zeta-✦missionary"/' kernel/arch/arm64/configs/gki_defconfig

      - name: Configure kernel (ThinLTO + tuning)
        run: |
          export ARCH=arm64
          export LLVM=1
          export LLVM_IAS=1
          export CC=clang
          export CXX=clang++
          export LD=ld.lld

          make -C kernel O=out gki_defconfig

          kernel/scripts/config --file kernel/out/.config \
            -e CONFIG_CC_IS_CLANG \
            -e CONFIG_LD_LLD \
            -e CONFIG_LTO_CLANG \
            -e CONFIG_THINLTO \
            -d CONFIG_LTO_CLANG_FULL \
            -e CONFIG_PREEMPT \
            -e CONFIG_PREEMPT_DYNAMIC \
            -e CONFIG_PREEMPT_COUNT \
            -e CONFIG_HZ_250 \
            -e CONFIG_NO_HZ_COMMON \
            -e CONFIG_NO_HZ_IDLE \
            -e CONFIG_HIGH_RES_TIMERS \
            -e CONFIG_SCHED_AUTOGROUP \
            -e CONFIG_SCHED_CORE \
            -e CONFIG_SCHED_HRTICK \
            -e CONFIG_UCLAMP_TASK \
            -e CONFIG_CPU_FREQ_GOV_SCHEDUTIL \
            -e CONFIG_CPU_IDLE \
            -e CONFIG_CPU_IDLE_GOV_MENU \
            -e CONFIG_CPU_IDLE_GOV_TEO \
            -e CONFIG_RCU_EXPERT \
            -e CONFIG_RCU_BOOST \
            -e CONFIG_RCU_BOOST_DELAY \
            -e CONFIG_RCU_NOCB_CPU \
            -e CONFIG_CGROUPS \
            -e CONFIG_CGROUP_SCHED \
            -e CONFIG_CGROUP_CPUACCT \
            -e CONFIG_CGROUP_FREEZER \
            -e CONFIG_CGROUP_BPF \
            -e CONFIG_NAMESPACES \
            -e CONFIG_USER_NS \
            -e CONFIG_PID_NS \
            -e CONFIG_NET_NS \
            -e CONFIG_IPC_NS \
            -e CONFIG_ZRAM \
            -e CONFIG_ZRAM_DEF_COMP_LZ4 \
            -e CONFIG_CRYPTO_LZ4 \
            -e CONFIG_ARM64_PAN \
            -e CONFIG_ARM64_UAO \
            -e CONFIG_ARM64_PTR_AUTH \
            -e CONFIG_ARM64_BTI \
            -e CONFIG_VDSO \
            -e CONFIG_OPTIMIZE_INLINING \
            -e CONFIG_DISABLE_UNUSED_SYMBOLS \
            -e CONFIG_KSU \
            -e CONFIG_KSU_SUSFS \
            -e CONFIG_KSU_MANUAL_HOOK

          make -C kernel O=out olddefconfig

      - name: Build kernel (RAM-safe)
        run: |
          export ARCH=arm64
          export LLVM=1
          export LLVM_IAS=1
          export CC="ccache clang"
          export CXX="ccache clang++"
          export LD=ld.lld
          make -C kernel O=out -j$(nproc --ignore=2)

      - name: Pack AnyKernel3
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 anykernel
          cp kernel/out/arch/arm64/boot/Image anykernel/ || true
          cp kernel/out/arch/arm64/boot/dtbo.img anykernel/ || true
          cd anykernel
          zip -r ../zeta-missionary.zip *

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: zeta-missionary
          path: zeta-missionary.zip
