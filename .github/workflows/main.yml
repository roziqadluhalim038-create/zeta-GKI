name: Missionary-Zeta GKI

on:
  workflow_dispatch:

jobs:
  Build-Kernel:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

      - run: |
          sudo apt update
          sudo apt install -y git make bc bison flex libssl-dev libelf-dev python3 zip ccache llvm lld

      - run: |
          mkdir -p /opt/clang
          git clone --depth=1 https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 /tmp/aosp-clang
          CLANG_DIR=$(ls /tmp/aosp-clang | grep '^clang-r' | sort -V | tail -n1)
          cp -r /tmp/aosp-clang/$CLANG_DIR/* /opt/clang/
          rm -rf /tmp/aosp-clang
          chmod -R a+rX /opt/clang
          echo "/opt/clang/bin" >> $GITHUB_PATH

      - run: |
          echo "CC=/opt/clang/bin/clang" >> $GITHUB_ENV
          echo "CXX=/opt/clang/bin/clang++" >> $GITHUB_ENV
          echo "LD=/opt/clang/bin/ld.lld" >> $GITHUB_ENV
          echo "LLVM=1" >> $GITHUB_ENV
          echo "LLVM_IAS=1" >> $GITHUB_ENV

      - run: |
          git clone --depth=1 https://github.com/fjrXTR/gki-5.10.git kernel

      - run: |
          rm -rf kernel/drivers/kernelsu
          git clone --depth=1 https://github.com/tiann/KernelSU.git /tmp/ksu
          mkdir -p kernel/drivers/kernelsu
          cp -a /tmp/ksu/kernel/* kernel/drivers/kernelsu/
          grep -q 'drivers/kernelsu/Kconfig' kernel/drivers/Kconfig || echo 'source "drivers/kernelsu/Kconfig"' >> kernel/drivers/Kconfig
          grep -q 'kernelsu/' kernel/drivers/Makefile || echo 'obj-$(CONFIG_KSU) += kernelsu/' >> kernel/drivers/Makefile
          rm -rf /tmp/ksu

      - run: |
          set -e
          export ARCH=arm64
          export SUBARCH=arm64
          export KCFLAGS="-O3 -pipe"
          export KCPPFLAGS="-O3"
          export KBUILD_BUILD_USER=Zeta
          export KBUILD_BUILD_HOST=Missionary

          mkdir -p kernel/out
          cd kernel

          make O=out gki_defconfig

          scripts/config --file out/.config \
            -e CONFIG_LOCALVERSION="-✦zeta-missionary" \
            -e CONFIG_CC_IS_CLANG -e CONFIG_LD_LLD \
            -e CONFIG_LTO_CLANG -e CONFIG_LTO_CLANG_FULL -d CONFIG_THINLTO \
            -e CONFIG_PREEMPT -e CONFIG_PREEMPT_DYNAMIC -e CONFIG_PREEMPT_COUNT \
            -e CONFIG_HIGH_RES_TIMERS -e CONFIG_TICK_ONESHOT -e CONFIG_NO_HZ_COMMON -e CONFIG_NO_HZ_IDLE -e CONFIG_HZ_250 \
            -e CONFIG_SCHED_AUTOGROUP -e CONFIG_SCHED_CORE -e CONFIG_SCHED_HRTICK -e CONFIG_UCLAMP_TASK \
            -e CONFIG_CPU_FREQ -e CONFIG_CPU_FREQ_GOV_SCHEDUTIL \
            -e CONFIG_CPU_IDLE -e CONFIG_CPU_IDLE_GOV_MENU -e CONFIG_CPU_IDLE_GOV_TEO \
            -e CONFIG_RCU_EXPERT -e CONFIG_RCU_NOCB_CPU -e CONFIG_RCU_BOOST -e CONFIG_RCU_BOOST_DELAY \
            -e CONFIG_ZRAM -e CONFIG_ZRAM_DEF_COMP_LZ4 -e CONFIG_CRYPTO_LZ4 \
            -e CONFIG_ARM64_PAN -e CONFIG_ARM64_UAO -e CONFIG_ARM64_PTR_AUTH -e CONFIG_ARM64_BTI \
            -e CONFIG_OPTIMIZE_INLINING -e CONFIG_DISABLE_UNUSED_SYMBOLS \
            -d CONFIG_DEBUG_KERNEL -d CONFIG_KPROBES -d CONFIG_FTRACE -d CONFIG_FUNCTION_TRACER \
            -e CONFIG_KSU -e CONFIG_KSU_SUSFS -e CONFIG_KSU_MANUAL_HOOK

          make O=out olddefconfig
          make O=out -j$(nproc --ignore=2)

      - run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git anykernel3
          cp kernel/out/arch/arm64/boot/Image anykernel3/
          cp kernel/out/arch/arm64/boot/dtbo.img anykernel3/ || true
          cd anykernel3
          zip -r ../✦zeta-missionary-Kernel.zip *

      - uses: actions/upload-artifact@v4
        with:
          name: zeta-missionary-kernel
          path: ✦zeta-missionary-Kernel.zip
