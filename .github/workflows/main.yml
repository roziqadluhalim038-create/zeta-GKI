name: zeta-missionary-build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Free disk & prep
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost || true
          sudo apt-get -y autoremove || true
          sudo apt clean || true
          df -h

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git bc bison flex libssl-dev libelf-dev \
            wget gnupg lsb-release xz-utils ccache python3 zip make build-essential

      - name: Install LLVM/Clang (apt)
        run: |
          wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
          sudo add-apt-repository "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-19 main"
          sudo apt update
          sudo apt install -y clang-19 lld-19 llvm-19
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-19 100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-19 100
          sudo update-alternatives --install /usr/bin/ld.lld ld.lld /usr/bin/ld.lld-19 100
          clang --version || true
          ld.lld --version || true

      - name: Setup ccache env
        run: |
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=8G" >> $GITHUB_ENV
          ccache -M 8G || true

      - name: Clone Valhaze kernel (stable default branch)
        run: |
          git clone --depth=1 https://github.com/fjrXTR/v1llx-gki-5.10 kernel

      - name: Add KernelSU-Next (clone into drivers)
        run: |
          rm -rf kernel/drivers/kernelsu || true
          git clone --depth=1 https://github.com/KernelSU-Next/KernelSU.git kernel/drivers/kernelsu
          # ensure drivers/Kconfig and drivers/Makefile reference kernelsu if needed
          if ! grep -Fq 'drivers/kernelsu/Kconfig' kernel/drivers/Kconfig 2>/dev/null ; then
            echo 'source "drivers/kernelsu/Kconfig"' >> kernel/drivers/Kconfig
          fi
          if ! grep -Fq 'obj-$(CONFIG_KSU) += kernelsu/' kernel/drivers/Makefile 2>/dev/null ; then
            echo 'obj-$(CONFIG_KSU) += kernelsu/' >> kernel/drivers/Makefile
          fi
          ls -la kernel/drivers/kernelsu || true

      - name: Prepare build dir
        run: |
          mkdir -p kernel/out
          df -h

      - name: Build gki_defconfig and compile (no config changes)
        env:
          ARCH: arm64
          SUBARCH: arm64
          CC: clang
          CXX: clang++
          LD: ld.lld
          LLVM: "1"
          LLVM_IAS: "1"
        run: |
          set -e
          cd kernel
          make O=out gki_defconfig
          # do not modify kernel config or localversion (user requested)
          make O=out olddefconfig || true
          # limit parallelism to avoid OOM on GitHub runners
          make O=out -j2

      - name: Collect artifacts (AnyKernel)
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 anykernel
          cp kernel/out/arch/arm64/boot/Image anykernel/ || true
          cp kernel/out/arch/arm64/boot/dtbo.img anykernel/ || true
          cd anykernel
          zip -r ../zeta-missionary-kernel.zip *
          ls -lh ../zeta-missionary-kernel.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: zeta-missionary-kernel
          path: zeta-missionary-kernel.zip
